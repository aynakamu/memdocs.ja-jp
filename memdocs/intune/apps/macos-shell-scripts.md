---
title: Microsoft Intune で macOS デバイスにシェル スクリプトを使用する | Microsoft Docs
description: Microsoft Intune での macOS デバイスのシェル スクリプトの作成、割り当て、監視、問題解決
keywords: ''
author: Erikre
ms.author: erikre
manager: dougeby
ms.date: 03/26/2020
ms.topic: conceptual
ms.service: microsoft-intune
ms.subservice: apps
ms.localizationpriority: high
ms.technology: ''
ms.assetid: ''
ms.reviewer: ''
ms.suite: ems
search.appverid: MET150
ms.custom: intune-azure
ms.collection: M365-identity-device-management
ms.openlocfilehash: 36936976528b5ea9c3fff1f77ec11223a4e4e63d
ms.sourcegitcommit: e7fb8cf2ffce29548b4a33b2a0c33a3a227c6bc4
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/30/2020
ms.locfileid: "80401785"
---
# <a name="use-shell-scripts-on-macos-devices-in-intune-public-preview"></a>Intune で macOS デバイスに対してシェル スクリプトを使用する (パブリック プレビュー)

> [!NOTE]
> macOS デバイスのシェル スクリプトは現在、プレビュー段階です。 この機能を利用し、[プレビューでわかった問題](macos-shell-scripts.md#known-issues)の一覧を確認します。

シェル スクリプトを利用することで、macOS オペレーティング システムでサポートされている範囲を超え、Intune でデバイス管理機能を拡張します。 

## <a name="prerequisites"></a>[前提条件]
シェル スクリプトを作成し、それを macOS デバイスに割り当てるとき、次の前提条件が満たされることを確認します。 
 - デバイスは macOS 10.12 以降を実行しています。
 - デバイスは Intune で管理されています。 
 - シェル スクリプトは `#!` で始まり、`#!/bin/sh` や `#!/usr/bin/env zsh` など、有効な場所に入れておく必要があります。
 - 該当するシェルのコマンドライン インタープリターがインストールされています。

## <a name="important-considerations-before-using-shell-scripts"></a>シェル スクリプトを使用する前に考慮すべき重要な事項
 - シェル スクリプトでは、Microsoft Intune MDM Agent が macOS デバイスに正常にインストールされていることが必須となります。 詳細については、「[Microsoft Intune MDM Agent for macOS](macos-shell-scripts.md#microsoft-intune-mdm-agent-for-macos)」を参照してください。
 - シェル スクリプトは、別個のプロセスとしてデバイス上で並列実行されます。
 - サインイン ユーザーとして実行されているシェル スクリプトは、実行時、デバイス上で現在サインインしているすべてのユーザー アカウントに対して実行されます。
 - サインイン ユーザーとして実行するスクリプトを実行するには、エンド ユーザーはデバイスにサインインする必要があります。
 - 標準のユーザー アカウントではできない変更がスクリプトで必要になる場合、ルート ユーザー特権が必須になります。
 - シェル スクリプトでは、ディスクがいっぱいになっている場合、ストレージの場所が改ざんされている場合、ローカル キャッシュが削除されている場合、Mac デバイスが再起動する場合など、特定の条件では、選択されたスクリプト頻度以上の実行が試行されます。
 
## <a name="create-and-assign-a-shell-script-policy"></a>シェル スクリプト ポリシーを作成し、割り当てる
1. [Microsoft Endpoint Manager 管理センター](https://go.microsoft.com/fwlink/?linkid=2109431)にサインインします。
2. **[デバイス]** 、 **[macOS]** 、 **[スクリプト]** 、 **[追加]** の順に選択します。
3. **[基本]** で、次のプロパティを入力し、 **[次へ]** を選択します。
   - **名前**:シェル スクリプトの名前を入力します。
   - **説明**:シェル スクリプトの説明を入力します。 この設定は省略可能ですが、推奨されます。
4. **[スクリプト設定]** で、次のプロパティを入力し、 **[次へ]** を選択します。
   - **スクリプトのアップロード**:シェル スクリプトを参照します。 スクリプト ファイルのサイズの上限は 200 KB 未満です。
   - **サインイン ユーザーとしてスクリプトを実行する**: **[はい]** を選択すると、デバイス上でユーザーの資格情報を使用してスクリプトが実行されます。 **[いいえ]** (既定) を選択すると、ルート ユーザーとしてスクリプトが実行されます。 
5. **[スコープ タグ]** で、必要に応じてスクリプトのスコープ タグを追加し、 **[次へ]** を選択します。 スコープ タグを使用し、Intune でスクリプトを表示できるユーザーを決定できます。 スコープのタグの詳細については、[分散 IT のためのロールベースのアクセス制御とスコープのタグの使用](../fundamentals/scope-tags.md)に関するページをご覧ください。
6. **[割り当て]**  >  **[含めるグループを選択]** の順に選択します。 Azure AD グループの既存のリストが表示されます。 スクリプトを受信する macOS デバイスを持つユーザーが属する 1 つまたは複数のデバイス グループを選択します。 **[選択]** を選択します。 選択したグループがリストに表示され、スクリプト ポリシーが与えられます。
   > [!NOTE]
   > - Intune 内のシェル スクリプトは、Azure AD デバイスのセキュリティ グループにのみ割り当てられます。 ユーザー グループ割り当てはプレビューではサポートされていません。 
   > - シェル スクリプトの割り当て更新では、[Microsoft Intune MDM Agent for macOS](macos-shell-scripts.md#microsoft-intune-mdm-agent-for-macos) の割り当ても更新されます。
7. **[確認 + 追加]** で、構成した設定の概要が表示されます。 **[追加]** を選択してスクリプトを保存します。 **[追加]** を選択すると、選択したグループにスクリプト ポリシーが展開されます。

今作成したスクリプトがスクリプトの一覧に表示されます。 

## <a name="monitor-a-shell-script-policy"></a>シェル スクリプト ポリシーを監視する
次のいずれかのレポートを選択すると、ユーザーとデバイスに割り当てられているすべてのスクリプトの実行状態を監視できます。
- **スクリプト** > **監視するスクリプトを選択する** > **デバイスの状態**
- **スクリプト** > **監視するスクリプトを選択する** > **ユーザーの状態**

>[!IMPORTANT]
> 選択した**スクリプト頻度**に関係なく、スクリプト実行状態は、スクリプトが最初に実行されたときにのみ、報告されます。 スクリプト実行状態は、後続の実行では更新されません。 ただし、更新後のスクリプトは新しいスクリプトとして扱われ、実行状態がもう一度報告されます。

スクリプトを実行すると、次のいずれかの状態が返されます。
- スクリプトの実行状態が**失敗**の場合、ゼロ以外の終了コードがスクリプトから返されたか、スクリプトの形式が正しくないことを示しています。 
- スクリプトの実行状態が**成功**の場合、スクリプトから終了コードとして 0 が返されたことを示しています。 

## <a name="frequently-asked-questions"></a>よく寄せられる質問
### <a name="why-are-assigned-shell-scripts-not-running-on-the-device"></a>割り当てたシェル スクリプトがデバイスで実行されません。なぜですか。
これには、次のような理由があります。
* 新しいスクリプトや更新後のスクリプトを受け取るには、エージェントのチェックインが必要になることがあります。 このチェックイン プロセスは 8 時間ごとに実行され、MDM チェックインとは異なります。 エージェントのチェックインを成功させるには、デバイスが起動しており、ネットワークに接続されていることを確認します。そして、エージェントがチェックインするのを待ちます。
* エージェントがインストールされていない可能性があります。 macOS デバイス上の `/Library/Intune/Microsoft Intune Agent.app` にエージェントがインストールされていることを確認します。
* エージェントが正常な状態ではない可能性があります。 エージェントは 24 時間回復を試行し、それでもシェル スクリプトが割り当てられている場合、エージェント自体を削除し、再インストールします。

### <a name="how-frequently-is-script-run-status-reported"></a>スクリプトの実行状態はどのくらいの頻度で報告されますか。
スクリプトの実行状態は、スクリプトの実行完了直後に Microsoft Endpoint Manager 管理コンソールに報告されます。 設定された頻度で定期的に実行されるようにスクリプトがスケジュールされている場合、初回実行時のみ状態が報告されます。

### <a name="when-are-shell-scripts-run-again"></a>シェル スクリプトが再実行されるのはいつですか。
スクリプトは、 **[スクリプトが失敗した場合の再試行回数の最大値]** 設定が構成されており、スクリプトが実行に失敗したときにのみ、再実行されます。 **[スクリプトが失敗した場合の再試行回数の最大値]** が構成されていないとき、スクリプトが実行に失敗した場合、再実行されず、**失敗**として実行状態が報告されます。 

### <a name="what-intune-role-permissions-are-required-for-shell-scripts"></a>シェル スクリプトにはどのような Intune ロールのアクセス許可が必要ですか。
シェル スクリプトを削除、割り当て、作成、更新、読み取りするには、割り当てた Intune ロールに**デバイス構成アクセス許可**が必要です。

## <a name="microsoft-intune-mdm-agent-for-macos"></a>Microsoft Intune MDM Agent for macOS
 ### <a name="why-is-the-agent-required"></a>エージェントはなぜ必要ですか。
 ネイティブの macOS オペレーティング システムではサポートされていない高度なデバイス管理機能を有効にするには、Microsoft Intune MDM Agent を管理対象の macOS デバイスにインストールする必要があります。
 
 ### <a name="how-is-the-agent-installed"></a>エージェントはどのようにインストールされますか。
 Microsoft Endpoint Manager Admin Center で少なくとも 1 つのシェル スクリプトを割り当てた Intune の管理対象 macOS デバイスにエージェントが通知なく、自動的にインストールされます。 エージェントは適切であれば `/Library/Intune/Microsoft Intune Agent.app` にインストールされ、macOS デバイスの **[Finder]** の **[アプリケーション]** には表示されません。 macOS デバイスで実行されているとき、エージェントは**アクティビティ モニター**に `IntuneMdmAgent` として表示されます。

### <a name="what-does-the-agent-do"></a>エージェントは何をしますか。
 - エージェントによって、チェックインして macOS デバイスに割り当てられたシェル スクリプトを受け取る前に、Intune サービスが通知なしで認証されます。
 - エージェントでは、割り当てられたシェル スクリプトが受け取られ、構成されているスケジュール、再試行、通知設定、管理者が設定したその他の設定に基づいてスクリプトが実行されます。
 - エージェントでは通常 8 時間おきに、新しいスクリプトやスクリプトの更新がないか Intune サービスに確認します。 このチェックイン プロセスは、MDM チェックインから独立しています。 

 >[!NOTE]
 > ポータル サイトの **[設定の確認]** アクションでは、MDM チェックインのみ強制されます。 エージェント チェックインには手動操作がありません。

 ### <a name="when-is-the-agent-removed"></a>エージェントはいつ削除されますか。
 次のような条件下でエージェントはデバイスから削除されます。
 - シェル スクリプトのデバイスへの割り当てが解除されました。 
 - macOS デバイスが管理対象から外されました。
 - エージェントが 24 時間 (デバイスの復帰時間) 以上、回復不可能な状態にあります。

 ### <a name="how-to-turn-off-usage-data-sent-to-microsoft-for-shell-scripts"></a>シェル スクリプト用として Microsoft に送信された使用状況データをオフにする方法はありますか。
 Intune MDM Agent から Microsoft に送信された使用状況データをオフにするには、ポータル サイトを開き、 **[メニュー]** 、 **[基本設定]** の順に選択し、"*使用状況データの収集を Microsoft に許可します*" のチェックを外します。 これで、Intune MDM エージェントとポータル サイトの両方に対して、送信された使用状況データがオフになります。

## <a name="known-issues"></a>既知の問題
- **ユーザー グループの割り当て:** ユーザー グループに割り当てられたシェル スクリプトはデバイスに適用されません。 ユーザー グループ割り当ては現在、プレビューではサポートされていません。 デバイス グループ割り当てを使用し、スクリプトを割り当てます。
- **ログの収集:** "ログの収集" アクションが表示されます。 ただし、ログの収集が試行されるとき、"エラーが発生しました" と表示され、ログはキャプチャされません。 ログの収集は現在、プレビューではサポートされていません。
- **スクリプト実行状態なし:** スクリプトがデバイスで受け取られても、実行状態が報告される前にデバイスがオフになることがまれに発生した場合、管理者コンソールでは、デバイスからスクリプトの実行状態が報告されません。
- **ユーザー状態レポート:** 空のレポートが発行されることがあります。 [Microsoft Endpoint Manager Admin Center](https://go.microsoft.com/fwlink/?linkid=2109431) で、 **[モニター]** を選択します。 ユーザーの状態には、空のレポートが表示されます。

## <a name="next-steps"></a>次のステップ

- [Microsoft Intune でコンプライアンス ポリシーを作成する](..\protect\create-compliance-policy.md)
