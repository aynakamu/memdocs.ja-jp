---
title: Microsoft Intune で macOS デバイスにシェル スクリプトを使用する | Microsoft Docs
description: Microsoft Intune での macOS デバイスのシェル スクリプトの作成、割り当て、監視、問題解決
keywords: ''
author: Erikre
ms.author: erikre
manager: dougeby
ms.date: 04/30/2020
ms.topic: conceptual
ms.service: microsoft-intune
ms.subservice: apps
ms.localizationpriority: high
ms.technology: ''
ms.assetid: ''
ms.reviewer: ''
ms.suite: ems
search.appverid: MET150
ms.custom: intune-azure
ms.collection: M365-identity-device-management
ms.openlocfilehash: c5839154ab0c884e933e8d11055e745d54503433
ms.sourcegitcommit: 8a8378b685a674083bfb9fbc9c0662fb0c7dda97
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/01/2020
ms.locfileid: "82619544"
---
# <a name="use-shell-scripts-on-macos-devices-in-intune-public-preview"></a>Intune で macOS デバイスに対してシェル スクリプトを使用する (パブリック プレビュー)

> [!NOTE]
> macOS デバイスのシェル スクリプトは現在、プレビュー段階です。 この機能を利用し、[プレビューでわかった問題](macos-shell-scripts.md#known-issues)の一覧を確認します。

シェル スクリプトを利用することで、macOS オペレーティング システムでサポートされている範囲を超え、Intune でデバイス管理機能を拡張します。 

## <a name="prerequisites"></a>[前提条件]
シェル スクリプトを作成し、それを macOS デバイスに割り当てるとき、次の前提条件が満たされることを確認します。 
 - デバイスは macOS 10.12 以降を実行しています。
 - デバイスは Intune で管理されています。 
 - シェル スクリプトは `#!` で始まり、`#!/bin/sh` や `#!/usr/bin/env zsh` など、有効な場所に入れておく必要があります。
 - 該当するシェルのコマンドライン インタープリターがインストールされています。

## <a name="important-considerations-before-using-shell-scripts"></a>シェル スクリプトを使用する前に考慮すべき重要な事項
 - シェル スクリプトでは、Microsoft Intune 管理エージェントが macOS デバイスに正常にインストールされていることが必須となります。 詳細については、「[macOS 用の Microsoft Intune 管理エージェント](macos-shell-scripts.md#microsoft-intune-management-agent-for-macos)」を参照してください。
 - シェル スクリプトは、別個のプロセスとしてデバイス上で並列実行されます。
 - サインイン ユーザーとして実行されているシェル スクリプトは、実行時、デバイス上で現在サインインしているすべてのユーザー アカウントに対して実行されます。
 - サインイン ユーザーとして実行するスクリプトを実行するには、エンド ユーザーはデバイスにサインインする必要があります。
 - 標準のユーザー アカウントではできない変更がスクリプトで必要になる場合、ルート ユーザー特権が必須になります。
 - シェル スクリプトでは、ディスクがいっぱいになっている場合、ストレージの場所が改ざんされている場合、ローカル キャッシュが削除されている場合、Mac デバイスが再起動する場合など、特定の条件では、選択されたスクリプト頻度以上の実行が試行されます。
 
## <a name="create-and-assign-a-shell-script-policy"></a>シェル スクリプト ポリシーを作成し、割り当てる
1. [Microsoft Endpoint Manager 管理センター](https://go.microsoft.com/fwlink/?linkid=2109431)にサインインします。
2. **[デバイス]** 、 **[macOS]** 、 **[スクリプト]** 、 **[追加]** の順に選択します。
3. **[基本]** で、次のプロパティを入力し、 **[次へ]** を選択します。
   - **名前**:シェル スクリプトの名前を入力します。
   - **説明**:シェル スクリプトの説明を入力します。 この設定は省略可能ですが、推奨されます。
4. **[スクリプト設定]** で、次のプロパティを入力し、 **[次へ]** を選択します。
   - **スクリプトのアップロード**:シェル スクリプトを参照します。 スクリプト ファイルのサイズの上限は 200 KB 未満です。
   - **サインイン ユーザーとしてスクリプトを実行する**: **[はい]** を選択すると、デバイス上でユーザーの資格情報を使用してスクリプトが実行されます。 **[いいえ]** (既定) を選択すると、ルート ユーザーとしてスクリプトが実行されます。 
   - **デバイスでスクリプトの通知を非表示にする:** 既定では、実行されるスクリプトごとにスクリプト通知が表示されます。 エンド ユーザーには、macOS デバイス上の Intune から "*IT がコンピューターを構成中です*" という通知が表示されます。
   - **スクリプトの頻度:** スクリプトが実行される頻度を選択します。 スクリプトを 1 回だけ実行する場合は、 **[未構成]** (既定値) を選択します。
   - **スクリプトが失敗した場合の再試行回数の最大値:** スクリプトによって 0 以外の終了コード (0 は成功を意味します) が返される場合に、スクリプトを実行する回数を選択します。 スクリプトが失敗したときに再試行しない場合は、 **[未構成]** (既定値) を選択します。
5. **[スコープ タグ]** で、必要に応じてスクリプトのスコープ タグを追加し、 **[次へ]** を選択します。 スコープ タグを使用し、Intune でスクリプトを表示できるユーザーを決定できます。 スコープのタグの詳細については、[分散 IT のためのロールベースのアクセス制御とスコープのタグの使用](../fundamentals/scope-tags.md)に関するページをご覧ください。
6. **[割り当て]**  >  **[含めるグループを選択]** の順に選択します。 Azure AD グループの既存のリストが表示されます。 スクリプトを受信する macOS デバイスを持つユーザーが属する 1 つまたは複数のデバイス グループを選択します。 **[選択]** を選択します。 選択したグループがリストに表示され、スクリプト ポリシーが与えられます。
   > [!NOTE]
   > - Intune 内のシェル スクリプトは、Azure AD デバイスのセキュリティ グループにのみ割り当てられます。 ユーザー グループ割り当てはプレビューではサポートされていません。 
   > - シェル スクリプトの割り当て更新では、[macOS 用の Microsoft Intune 管理エージェント](macos-shell-scripts.md#microsoft-intune-management-agent-for-macos)の割り当ても更新されます。
7. **[確認 + 追加]** で、構成した設定の概要が表示されます。 **[追加]** を選択してスクリプトを保存します。 **[追加]** を選択すると、選択したグループにスクリプト ポリシーが展開されます。

今作成したスクリプトがスクリプトの一覧に表示されます。 

## <a name="monitor-a-shell-script-policy"></a>シェル スクリプト ポリシーを監視する
次のいずれかのレポートを選択すると、ユーザーとデバイスに割り当てられているすべてのスクリプトの実行状態を監視できます。
- **スクリプト** > **監視するスクリプトを選択する** > **デバイスの状態**
- **スクリプト** > **監視するスクリプトを選択する** > **ユーザーの状態**

>[!IMPORTANT]
> 選択した**スクリプト頻度**に関係なく、スクリプト実行状態は、スクリプトが最初に実行されたときにのみ、報告されます。 スクリプト実行状態は、後続の実行では更新されません。 ただし、更新後のスクリプトは新しいスクリプトとして扱われ、実行状態がもう一度報告されます。

スクリプトを実行すると、次のいずれかの状態が返されます。
- スクリプトの実行状態が**失敗**の場合、ゼロ以外の終了コードがスクリプトから返されたか、スクリプトの形式が正しくないことを示しています。 
- スクリプトの実行状態が**成功**の場合、スクリプトから終了コードとして 0 が返されたことを示しています。 

## <a name="troubleshoot-macos-shell-script-policies-using-log-collection"></a>ログ収集を使用して macOS シェル スクリプト ポリシーのトラブルシューティングを行う

デバイスのログを収集すると、macOS デバイスでのスクリプトに関する問題のトラブルシューティングに役立てることができます。 

### <a name="requirements-for-log-collection"></a>ログ収集の要件
macOS デバイスでログを収集するには、次の項目が必要です。
- ログ ファイルの完全な絶対パスを指定する必要があります。
- ファイル パスはセミコロン (;) で区切る必要があります。
- アップロードできるログ収集の最大サイズは、60 MB (圧縮後) または 25 ファイルのうち、どちらか早い方です。
- ログ収集に使用できるファイルの種類には、 *.log、.zip、.gz、.tar、.txt、.xml、.crash、.rtf* などの拡張子があります。

#### <a name="collect-device-logs"></a>デバイスのログを回収する
1. [Microsoft Endpoint Manager 管理センター](https://go.microsoft.com/fwlink/?linkid=2109431)にサインインします。
2. **[デバイスの状態]** または **[ユーザーの状態]** レポートで、デバイスを選択します。
3. **[ログの収集]** を選択し、ログ ファイルのフォルダー パスをセミコロン (;) のみで区切って指定します (パスの間に空白や改行は入れません)。<br>たとえば、複数のパスは、`/Path/to/logfile1.zip;/Path/to/logfile2.log` のように記述する必要があります。 

   >[!IMPORTANT]
   > コンマ、ピリオド、改行、引用符を使用して区切られた複数のログ ファイル パスは、空白の有無にかかわらず、ログ収集エラーになります。 パス間の区切り文字として空白を使用することもできません。

4. **[OK]** を選択します。 デバイス上の Intune 管理エージェントが次回 Intune にチェックインしたときに、ログが収集されます。 通常、このチェックインは 8 時間ごとに実行されます。

   >[!NOTE]
   > 
   > - 収集されたログは、デバイス上で暗号化され、Microsoft Azure Storage に送信されて、30 日間保存されます。 保存されたログは、要求時に暗号化解除され、Microsoft Endpoint Manager admin center を使用してダウンロードされます。
   > - 管理者指定のログに加えて、`/Library/Logs/Microsoft/Intune` と `~/Library/Logs/Microsoft/Intune` の各フォルダーから Intune 管理エージェント ログも収集されます。 エージェント ログのファイル名は `IntuneMDMDaemon date--time.log` と `IntuneMDMAgent date--time.log` です。 
   > - 管理者指定のファイルが見つからなかったり、ファイル拡張子が間違っていたりする場合は、これらのファイル名が `LogCollectionInfo.txt` に一覧表示されます。     

### <a name="log-collection-errors"></a>ログ収集エラー
次の表に示すいずれかの理由により、ログの収集が正常に行われない可能性があります。 これらのエラーを解決するには、修復ステップに従います。

| エラー コード (16 進) | エラー コード (10 進) | エラー メッセージ | 修復ステップ |
|------------------|------------------|---------------|-------------------|
| 0X87D300D1 | 2016214834 | ログ ファイルのサイズは、60 MB を超えることはできません。 | 圧縮後のログのサイズが 60 MB 未満であることを確認します。 |
| 0X87D300D1 | 2016214831 | 指定されたログ ファイルのパスが存在する必要があります。 システム ユーザー フォルダーは、無効なログ ファイルの場所です。 | 指定されたファイル パスが有効で、アクセス可能であることを確認します。 |
| 0X87D300D2 | 2016214830 | アップロード URL の有効期限が切れたため、ログ収集ファイルのアップロードに失敗しました。 | **[ログの収集]** アクションを再試行します。 |
| 0X87D300D3、0X87D300D5、0X87D300D7 | 2016214829、2016214827、2016214825 | 暗号化エラーにより、ログ収集ファイルのアップロードに失敗しました。 ログのアップロードを再試行してください。 | **[ログの収集]** アクションを再試行します。 |
| | 2016214828 | ログ ファイルの数が許可されている制限数 25 ファイルを超えました。 | 一度に収集できるログ ファイルの数は、最大 25 ファイルのみです。 |
| 0X87D300D6 | 2016214826 | zip エラーにより、ログ収集ファイルのアップロードに失敗しました。 ログのアップロードを再試行してください。 | **[ログの収集]** アクションを再試行します。 |
| | 2016214740 | 圧縮済みのログが見つからなかったため、ログを暗号化できませんでした。 | **[ログの収集]** アクションを再試行します。 |
| | 2016214739 | ログが収集されましたが、保存できませんでした。 | **[ログの収集]** アクションを再試行します。 |

## <a name="frequently-asked-questions"></a>よく寄せられる質問
### <a name="why-are-assigned-shell-scripts-not-running-on-the-device"></a>割り当てたシェル スクリプトがデバイスで実行されません。なぜですか。
これには、次のような理由があります。
* 新しいスクリプトや更新後のスクリプトを受け取るには、エージェントのチェックインが必要になることがあります。 このチェックイン プロセスは 8 時間ごとに実行され、MDM チェックインとは異なります。 エージェントのチェックインを成功させるには、デバイスが起動しており、ネットワークに接続されていることを確認します。そして、エージェントがチェックインするのを待ちます。
* エージェントがインストールされていない可能性があります。 macOS デバイス上の `/Library/Intune/Microsoft Intune Agent.app` にエージェントがインストールされていることを確認します。
* エージェントが正常な状態ではない可能性があります。 エージェントは 24 時間回復を試行し、それでもシェル スクリプトが割り当てられている場合、エージェント自体を削除し、再インストールします。

### <a name="how-frequently-is-script-run-status-reported"></a>スクリプトの実行状態はどのくらいの頻度で報告されますか。
スクリプトの実行状態は、スクリプトの実行完了直後に Microsoft Endpoint Manager 管理コンソールに報告されます。 設定された頻度で定期的に実行されるようにスクリプトがスケジュールされている場合、初回実行時のみ状態が報告されます。

### <a name="when-are-shell-scripts-run-again"></a>シェル スクリプトが再実行されるのはいつですか。
スクリプトは、 **[スクリプトが失敗した場合の再試行回数の最大値]** 設定が構成されており、スクリプトが実行に失敗したときにのみ、再実行されます。 **[スクリプトが失敗した場合の再試行回数の最大値]** が構成されていないとき、スクリプトが実行に失敗した場合、再実行されず、**失敗**として実行状態が報告されます。 

### <a name="what-intune-role-permissions-are-required-for-shell-scripts"></a>シェル スクリプトにはどのような Intune ロールのアクセス許可が必要ですか。
シェル スクリプトを削除、割り当て、作成、更新、読み取りするには、割り当てた Intune ロールに**デバイス構成アクセス許可**が必要です。

## <a name="microsoft-intune-management-agent-for-macos"></a>macOS 用の Microsoft Intune 管理エージェント
 ### <a name="why-is-the-agent-required"></a>エージェントはなぜ必要ですか。
ネイティブの macOS オペレーティング システムではサポートされていない高度なデバイス管理機能を有効にするには、Microsoft Intune 管理エージェントをマネージド macOS デバイスにインストールする必要があります。
 
 ### <a name="how-is-the-agent-installed"></a>エージェントはどのようにインストールされますか。
 Microsoft Endpoint Manager Admin Center で少なくとも 1 つのシェル スクリプトを割り当てた Intune の管理対象 macOS デバイスにエージェントが通知なく、自動的にインストールされます。 エージェントは適切であれば `/Library/Intune/Microsoft Intune Agent.app` にインストールされ、macOS デバイスの **[Finder]** の **[アプリケーション]** には表示されません。 macOS デバイスで実行されているとき、エージェントは**アクティビティ モニター**に `IntuneMdmAgent` として表示されます。

### <a name="what-does-the-agent-do"></a>エージェントは何をしますか。
 - エージェントによって、チェックインして macOS デバイスに割り当てられたシェル スクリプトを受け取る前に、Intune サービスが通知なしで認証されます。
 - エージェントでは、割り当てられたシェル スクリプトが受け取られ、構成されているスケジュール、再試行、通知設定、管理者が設定したその他の設定に基づいてスクリプトが実行されます。
 - エージェントでは通常 8 時間おきに、新しいスクリプトやスクリプトの更新がないか Intune サービスに確認します。 このチェックイン プロセスは、MDM チェックインから独立しています。 
 
 ### <a name="how-can-i-manually-initiate-an-agent-check-in-from-a-mac"></a>Mac からエージェントのチェックインを手動で開始するにはどうすればよいですか。
エージェントがインストールされている管理対象 Mac 上で、**ターミナル**を開き、`sudo killall IntuneMdmAgent` コマンドを実行して `IntuneMdmAgent` プロセスを終了します。 `IntuneMdmAgent` プロセスは直ちに再起動され、Intune でチェックインが開始されます。

または、次の操作を行うこともできます。
1. **[利用状況モニター]**  >  **[表示]** の順に開き、" ***[すべてのプロセス]** を選択します。* " 
2. `IntuneMdmAgent` という名前のプロセスを検索します。 
3. **root** ユーザーに対して実行されているプロセスを終了します。 

> [!NOTE]
> ポータル サイトの **[設定の確認]** アクションと Microsoft Endpoint Manager 管理コンソールのデバイスに対する **[同期]** アクションでは、MDM チェックインが開始され、エージェントのチェックインが強制されることはありません。

 ### <a name="when-is-the-agent-removed"></a>エージェントはいつ削除されますか。
 次のような条件下でエージェントはデバイスから削除されます。
 - シェル スクリプトのデバイスへの割り当てが解除されました。 
 - macOS デバイスが管理対象から外されました。
 - エージェントが 24 時間 (デバイスの復帰時間) 以上、回復不可能な状態にあります。

 ### <a name="how-to-turn-off-usage-data-sent-to-microsoft-for-shell-scripts"></a>シェル スクリプト用として Microsoft に送信された使用状況データをオフにする方法はありますか。
 Intune 管理エージェントから Microsoft に送信された使用状況データをオフにするには、ポータル サイトを開き、 **[メニュー]**  >  **[基本設定]** の順に選択し >  *[使用状況データの収集を Microsoft に許可します]* をオフにします。 これで、エージェントとポータル サイトの両方に対して、送信された使用状況データがオフになります。

## <a name="known-issues"></a>既知の問題
- **ユーザー グループの割り当て:** ユーザー グループに割り当てられたシェル スクリプトはデバイスに適用されません。 ユーザー グループ割り当ては現在、プレビューではサポートされていません。 デバイス グループ割り当てを使用し、スクリプトを割り当てます。
- **ログの収集:** "ログの収集" アクションが表示されます。 ただし、ログの収集が試行されるとき、"エラーが発生しました" と表示され、ログはキャプチャされません。 ログの収集は現在、プレビューではサポートされていません。
- **スクリプト実行状態なし:** スクリプトがデバイスで受け取られても、実行状態が報告される前にデバイスがオフになることがまれに発生した場合、管理者コンソールでは、デバイスからスクリプトの実行状態が報告されません。
- **ユーザー状態レポート:** 空のレポートが発行されることがあります。 [Microsoft Endpoint Manager Admin Center](https://go.microsoft.com/fwlink/?linkid=2109431) で、 **[モニター]** を選択します。 ユーザーの状態には、空のレポートが表示されます。

## <a name="next-steps"></a>次のステップ

- [Microsoft Intune でコンプライアンス ポリシーを作成する](..\protect\create-compliance-policy.md)
