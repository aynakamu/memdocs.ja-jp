---
title: OS をキャプチャするタスク シーケンスの作成
titleSuffix: Configuration Manager
description: 構築とキャプチャを実行するタスク シーケンスにより、OS とともに特定のドライバーとソフトウェアの更新プログラムを含めることができる参照コンピューターを構築できます。
ms.date: 11/29/2019
ms.prod: configuration-manager
ms.technology: configmgr-osd
ms.topic: how-to
ms.assetid: 25e4ac68-0e78-4bbe-b8fc-3898b372c4e8
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: 349ae2b8d574904d25f6f23bfb1707bb11df8af0
ms.sourcegitcommit: d225ccaa67ebee444002571dc8f289624db80d10
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/12/2020
ms.locfileid: "88125510"
---
# <a name="create-a-task-sequence-to-capture-an-os"></a>OS をキャプチャするタスク シーケンスの作成

*適用対象:Configuration Manager (Current Branch)*

Configuration Manager でタスク シーケンスを使用してコンピューターに OS を展開すると、タスク シーケンス内で指定した OS イメージがそのコンピューターによってインストールされます。 OS イメージをカスタマイズして、特定のドライバー、アプリケーション、ソフトウェア更新プログラムを含めることができます。 まず、構築とキャプチャを実行するタスク シーケンスを使用して、参照コンピューターを構築します。 次に、その参照コンピューターから OS イメージをキャプチャします。 既にキャプチャに使用可能な参照コンピューターがある場合は、カスタム タスク シーケンスを作成して OS をキャプチャします。

## <a name="about-the-build-and-capture-task-sequence"></a><a name="BKMK_BuildCaptureTS"></a> 構築とキャプチャを実行するタスク シーケンスについて

構築とキャプチャを実行するタスク シーケンス:

- 参照コンピューターのパーティション作成とフォーマットを行う
- OS をインストールする
- 構成マネージャー クライアントをインストールする
- アプリケーションをインストールする
- ソフトウェア更新プログラムを適用する
- 参照コンピューターから OS をキャプチャする

アプリケーションなどのタスク シーケンスに関連付けられているパッケージは、構築およびキャプチャを実行するタスク シーケンスを展開する前に配布ポイントに用意しておく必要があります。

## <a name="requirements"></a><a name="BKMK_CreatePackages"></a> 要件

OS をインストールするタスク シーケンスを作成する前に、次のコンポーネントの準備ができていることを確認してください。  

### <a name="required"></a>必須

- [ブート イメージ](../get-started/manage-boot-images.md)

- [OS イメージ](../get-started/manage-operating-system-images.md)

### <a name="required-if-used"></a>必須 (使用する場合)

- 参照コンピューターのハードウェアをサポートするために必要な Windows ドライバーを含む[ドライバー パッケージ](../get-started/manage-drivers.md)。 ドライバーを管理するためのタスク シーケンス ステップの詳細については、「[タスク シーケンスを使用したデバイス ドライバーのインストール](../get-started/manage-drivers.md#BKMK_TSDrivers)」をご覧ください。

- [ソフトウェア更新プログラム](../../sum/get-started/synchronize-software-updates.md)

- [アプリケーション](../../apps/deploy-use/create-applications.md)

## <a name="create-a-build-and-capture-task-sequence"></a><a name="BKMK_CreateBuildCaptureTS"></a> 構築とキャプチャを実行するタスク シーケンスの作成

次の手順に従って、タスク シーケンスを使用して、参照コンピューターを構築し、OS をキャプチャします。

1. Configuration Manager コンソールで、 **[ソフトウェア ライブラリ]** ワークスペースに移動し、 **[オペレーティング システム]** を展開して **[タスク シーケンス]** ノードを選択します。  

1. リボンの **[ホーム]** タブの **[作成]** グループで **[タスク シーケンスの作成]** をクリックして、タスク シーケンスの作成ウィザードを起動します。  

1. **新しいタスク シーケンスの作成** ページで、 **[参照オペレーティング システム イメージを構築およびキャプチャする]** を選択します。  

1. **[タスク シーケンス情報]** ページで次の設定を指定します。  

    - **タスク シーケンス名**:タスク シーケンスを識別する名前を指定します。  

    - **説明**:必要に応じて提供情報の説明を指定します。 たとえば、タスク シーケンスによって作成される OS について説明します。

    - **ブート イメージ**: このタスク シーケンスで使用するブート イメージを指定します。  

        > [!IMPORTANT]  
        > ブート イメージのアーキテクチャは、対象となるコンピューターのハードウェア アーキテクチャと互換性がある必要があります。  

1. **[Windows のインストール]** ページで次の設定を指定します。  

    - **イメージ パッケージ**: OS をインストールするのに必要なファイルが含まれている OS イメージ パッケージを指定します。  

    - **イメージ インデックス**: イメージにインストールする OS のインデックスを指定します。 OS イメージに複数のバージョンが含まれている場合は、インストールするバージョンを選択します。  

    - **プロダクト キー**: 必要に応じて、インストールする Windows OS のプロダクト キーを指定します。 エンコードされたボリューム ライセンス キーと標準のプロダクト キーを指定できます。 エンコードされていないプロダクト キーを使用する場合は、5 文字の各グループをダッシュ (`-`) で区切ります。 例: `XXXXX-XXXXX-XXXXX-XXXXX-XXXXX`  

    - **サーバー ライセンス モード**:必要に応じて、サーバー ライセンスを **[接続クライアント数]** 、 **[同時使用ユーザー数]** 、またはライセンスを指定しないものとして指定します。 サーバー ライセンスが **[同時使用ユーザー数]** の場合は、サーバー接続の最大数も指定します。  

    - 展開された OS の管理者アカウントを構成する方法を指定します。  

        - **ローカルの管理者パスワードをランダムに生成し、サポートされているすべてのプラットフォームのアカウントを無効にする**: ローカル管理者アカウント用にランダムなパスワードを作成します。 Windows が設定されている場合は、そのアカウントを無効にします。

        - **アカウントを有効にし、ローカル管理者パスワードを指定する**: この OS を展開するすべてのコンピューター上でローカル管理者アカウントに同じパスワードを使用します。

1. **[ネットワークの構成]** ページで次の設定を指定します。

    - **ワークグループに参加**:OS が展開された際に、セットアップ先のコンピューターをワークグループに追加するかどうかを指定します。  

    - **ドメインに参加**:OS が展開された際に、セットアップ先のコンピューターをドメインに追加するかどうかを指定します。 **[ドメイン]** にドメインの名前を指定します。  

        > [!IMPORTANT]  
        > ローカル フォレストの場合は、ドメインを参照して選択できます。 リモート フォレストのドメイン名を指定します。

        組織単位 (OU) も指定することができます。 この設定は省略可能です。コンピューター アカウントがまだ存在しない場合に作成する OU の LDAP X.500 識別名を指定します。  

    - **アカウント**:指定したドメインに参加するアクセス許可を持つアカウントの、ユーザー名とパスワードを指定します。 例: `domain\user` または `%variable%`。  

        > [!IMPORTANT]  
        > 展開中にドメイン設定またはワークグループ設定のいずれかを移行する計画である場合は、ここで必ず適切なドメイン資格情報を入力してください。  

1. **[Configuration Manager のインストール]** ページで、構成マネージャー クライアント パッケージを指定します。 このパッケージには、構成マネージャー クライアントをインストールするためのソース ファイルが含まれています。 また、クライアントをインストールするために必要な追加のプロパティも指定します。  

    詳しくは、[クライアント インストールのプロパティ](../../core/clients/deploy/about-client-installation-properties.md)に関するページをご覧ください。

1. **[更新プログラムを含める]** ページで、必要なソフトウェア更新プログラム、すべてのソフトウェア更新プログラム、またはソフトウェア更新プログラムなしを指定します。 ソフトウェア更新プログラムをインストールするように指定する場合、Configuration Manager は、セットアップ先のコンピューターがメンバーとなっているコレクション向けのソフトウェア更新プログラムのみをインストールします。  

1. **[アプリケーションのインストール]** ページで、展開先コンピューターにインストールするアプリケーションを指定します。 複数のアプリケーションを指定する場合は、特定のアプリケーションのインストールに失敗したときにタスク シーケンスを続行するかどうかも指定することができます。  

    > [!NOTE]
    > ウィザードでは次に **[システムの準備]** ページが表示されますが、これは使用されなくなりました。 **[次へ]** を選択して続行します。

1. **[イメージのプロパティ]** ページで、OS イメージに関する以下の設定を指定します。

    - **作成者**: OS イメージの作成者として示されるユーザーの名前を指定します。  

    - **バージョン**:OS イメージに関連付けた自分のバージョン番号を指定します。 この属性が OS バージョンである必要はありません。その値が別途サイトに格納されるためです。

    - **説明**:OS イメージに関して使用する説明を指定します。  

1. **[イメージのキャプチャ]** ページで、次の設定を指定します。

    - **パス**:出力イメージ ファイル (.wim) が Configuration Manager によって格納されるようにする共有ネットワーク フォルダーを指定します。 このファイルには、このウィザードで指定した設定に基づく OS イメージが含まれています。 指定したフォルダーに既存の .WIM ファイルが含まれている場合、それは上書きされます。  

    - **アカウント**:イメージが保存されているネットワーク共有へのアクセス許可を持つ Windows アカウントを指定します。  

1. ウィザードを完了します。  

タスク シーケンスにさらにステップを追加するには、それを選択し、 **[編集]** を選択します。 タスク シーケンスの編集方法の詳細については、「[Use the task sequence editor](../understand/task-sequence-editor.md)」 (タスク シーケンス エディターの使用) を参照してください。  

次の方法のいずれかで、タスク シーケンスを参照コンピューターに展開します。  

- 参照コンピューターが既に構成マネージャー クライアントである場合は、参照コンピューターを含むコレクションに構築とキャプチャを実行するタスク シーケンスを展開します。 詳細については、「 [Deploy a task sequence](deploy-a-task-sequence.md)」をご覧ください。

- 参照コンピューターが構成マネージャー クライアントではない場合、または参照コンピューターでタスク シーケンスを手動で実行する場合は、 **[タスク シーケンス メディアの作成ウィザード]** を使用して、起動可能なメディアを作成します。 詳細については、「[起動可能なメディアの作成](create-bootable-media.md)」を参照してください。  

イメージをキャプチャしたら、それを他のコンピューターに展開することができます。 キャプチャした OS イメージを展開する方法の詳細については、「[OS をインストールするタスク シーケンスの作成](create-a-task-sequence-to-install-an-operating-system.md)」を参照してください。  

## <a name="capture-from-an-existing-reference-computer"></a><a name="BKMK_CaptureExistingRefComputer"></a> 既存の参照コンピューターからキャプチャする

キャプチャの準備ができている参照コンピューターが既にある場合は、参照コンピューターから OS をキャプチャするタスク シーケンスを作成します。 参照コンピューターから 1 つ以上のイメージをキャプチャし、指定したネットワーク共有上にあるイメージ ファイル (.wim) に保存するには、 **[オペレーティング システム イメージのキャプチャ]** のタスク シーケンス ステップを使用します。 ブート イメージを使用して Windows PE で参照コンピューターを起動します。 このタスク シーケンスでは、参照コンピューターの各ハード ドライブが .wim ファイル内に別のイメージとしてキャプチャされます。 参照コンピューターに複数のドライブがある場合、作成される .wim ファイルには、ボリュームごとに異なるイメージが含まれています。 NTFS または FAT32 としてフォーマットされているボリュームのみがキャプチャされます。 その他のフォーマットのボリュームまたは USB のボリュームはスキップされます。  

次の手順を使用して、OS イメージを既存の参照コンピューターからキャプチャします。

1. Configuration Manager コンソールで、 **[ソフトウェア ライブラリ]** ワークスペースに移動し、 **[オペレーティング システム]** を展開して **[タスク シーケンス]** ノードを選択します。  

1. リボンの **[ホーム]** タブにある **[作成]** グループで、 **[タスク シーケンスの作成]** を選択します。 このアクションにより、タスク シーケンスの作成ウィザードが起動します。  

1. **[新しいタスク シーケンスの作成]** ページで **[新しいカスタム タスク シーケンスを作成する]** を選択します。  

1. **[タスク シーケンス情報]** ページで、タスク シーケンスの名前を指定します。 必要に応じて、タスク シーケンスの説明を追加します。  

1. タスク シーケンスのブート イメージを指定します。 Configuration Manager では、このブート イメージを使用して、参照コンピューターが Windows PE で起動されます。 詳細については、「[ブート イメージの管理](../get-started/manage-boot-images.md)」をご覧ください。  

1. ウィザードを完了します。  

1. **[タスク シーケンス]** ノードで、新しいタスク シーケンスを選択します。 次に、リボンの **[ホーム]** タブにある **[タスク シーケンス]** グループで、 **[編集]** を選択します。 このアクションにより、タスク シーケンス エディターが開きます。  

1. 構成マネージャー クライアントが参照コンピューターにインストールされている場合:

    **[追加]** メニューに進み、 **[イメージ]** を選択してから、[[ConfigMgr クライアントのキャプチャの準備]](../understand/task-sequence-steps.md#BKMK_PrepareConfigMgrClientforCapture) を選択します。 このステップにより、構成マネージャー クライアントが参照コンピューターに対して一般化されます。

    > [!Note]  
    > タスク シーケンスでは、構成マネージャー クライアントのアンインストールはサポートされていません。

1. **[追加]** メニューに進み、 **[イメージ]** を選択してから、[[Windows のキャプチャの準備]](../understand/task-sequence-steps.md#BKMK_PrepareWindowsforCapture) を選択します。 このステップで Sysprep が実行され、タスク シーケンスに指定した Windows PE ブート イメージでコンピューターが再起動されます。 このアクションが正常に完了するには、参照コンピューターをドメインに参加させないでください。

1. **[追加]** メニューに進み、 **[イメージ]** を選択してから、[[オペレーティング システム イメージのキャプチャ]](../understand/task-sequence-steps.md#BKMK_CaptureOperatingSystemImage) を選択します。 このステップは、Windows PE からのみ実行され、参照コンピューターのハード ドライブをキャプチャします。 次の設定を構成します。

    - **[名前]** と **[説明]** :必要に応じて、タスク シーケンス ステップの名前を変更し、説明を入力できます。  

    - **保存先**:出力 .WIM ファイルが保存されている共有ネットワーク フォルダーを指定します。 このファイルには、このウィザードを使用して指定した設定に基づく OS イメージが含まれます。 指定したフォルダーに既存の .WIM ファイルが含まれている場合、それは上書きされます。  

    - **[説明]** 、 **[バージョン]** 、および **[作成者]** :必要に応じて、キャプチャするイメージの詳細を指定します。  

    - **オペレーティング システム イメージのキャプチャ アカウント**:指定したネットワーク共有へのアクセス許可がある Windows アカウントを指定します。 その Windows アカウントの名前を指定するには、 **[設定]** を選択します。  

**[OK]** を選択して変更を保存し、タスク シーケンス エディターを閉じます。  

次の方法のいずれかで、タスク シーケンスを参照コンピューターに展開します。  

- 参照コンピューターが既に構成マネージャー クライアントである場合は、参照コンピューターを含むコレクションにキャプチャを実行するタスク シーケンスを展開します。 詳細については、「 [Deploy a task sequence](deploy-a-task-sequence.md)」をご覧ください。

- 参照コンピューターが構成マネージャー クライアントではない場合、または参照コンピューターでタスク シーケンスを手動で実行する場合は、 **[タスク シーケンス メディアの作成ウィザード]** を使用して、キャプチャ メディアを作成します。 詳細については、「[キャプチャ メディアを作成する](create-capture-media.md)」を参照してください。  

イメージをキャプチャしたら、それを他のコンピューターに展開することができます。 キャプチャした OS イメージを展開する方法の詳細については、「[OS をインストールするタスク シーケンスの作成](create-a-task-sequence-to-install-an-operating-system.md)」を参照してください。

## <a name="example-task-sequence"></a><a name="BKMK_BuildandCaptureTSExample"></a> タスク シーケンスの例

OS イメージを構築およびキャプチャするタスク シーケンスを作成する場合は、次の表をガイドとして使用してください。 この表を利用して、タスク シーケンス ステップの全般的な順序と、これらのステップを論理的なグループに整理および構造化する方法を決定できます。 自分で作成するタスク シーケンスは、このサンプルとは異なるものと考えられます。 含めるステップおよびグループは、これより多くすることも少なくすることもできます。

> [!NOTE]  
> この種類のタスク シーケンスを作成するには、タスク シーケンスの新規作成ウィザードを常に使用します。
>
> このウィザードでは、手動で同じステップを追加した場合に表示されるものとは少々異なる名前でステップがタスク シーケンスに追加されます。

### <a name="group-build-the-reference-machine"></a>グループ: 参照コンピューターの構築

このグループには、参照コンピューターを構築するのに必要なアクションが含まれます。

|タスク シーケンスのステップ|[説明]|  
|-------------------------------|---------------|  
|**Windows PE での再起動**|ターゲット コンピューターを、タスク シーケンスに割り当てられたブート イメージに再起動します。 このステップでは、インストールを続行するためにコンピューターを再起動することをユーザーに示すメッセージが表示されます。<br /><br />このステップでは、読み取り専用の `_SMSTSInWinPE` タスク シーケンス変数が使用されます。 関連する値が `false` の場合に、タスク シーケンス ステップが続行されます。|
|**ディスク 0 のパーティション作成 - BIOS**|ターゲット コンピューターのハード ドライブのパーティション作成およびフォーマットを BIOS モードで行います。 既定のディスク番号は `0` です。<br /><br />このステップでは、読み取り専用のタスク シーケンス変数がいくつか使用されます。 たとえば、それが実行されるのは、構成マネージャー クライアント キャッシュが存在しない場合のみですが、コンピューターが UEFI 用に構成されている場合は実行されません。|
|**ディスク 0 のパーティション作成 - UEFI**|ターゲット コンピューターのハード ドライブのパーティション作成およびフォーマットを UEFI モードで行います。 既定のディスク番号は `0` です。<br /><br />このステップでは、読み取り専用のタスク シーケンス変数がいくつか使用されます。 たとえば、それが実行されるのは、構成マネージャー クライアント キャッシュが存在しない場合で、かつコンピューターが UEFI 用に構成されている場合のみです。|
|**オペレーティング システムの適用**|指定された OS イメージをターゲット コンピューターにインストールします。 このステップでは最初に、Configuration Manager 固有のコントロール ファイルを除く、ボリューム上のすべてのファイルが削除されます。 その後、WIM ファイルに含まれるすべてのボリューム イメージが、ターゲット コンピューター上の対応する順次ディスク ボリュームに適用されます。|
|**Windows 設定の適用**|対象コンピューターの Windows 設定を構成します。|
|**ネットワーク設定の適用**|対象コンピューターのネットワークまたはワークグループ構成情報を指定します。|
|**デバイス ドライバーの適用**|この OS 展開の一環としてドライバーを照合してインストールします。 詳細については、「[Auto Apply Drivers](../understand/task-sequence-steps.md#BKMK_AutoApplyDrivers)」(ドライバーの自動適用) を参照してください。<br /><br />このステップでは、読み取り専用の `_SMSTSMediaType` タスク シーケンス変数が使用されます。 関連付けられた値が `FullMedia` と一致しない場合、このステップは実行されません。|
|**Windows と Configuration Manager のセットアップ**|構成マネージャー クライアント ソフトウェアをインストールします。 Configuration Manager は、Configuration Manager クライアントの GUID をインストールして登録します。 必要な**インストール プロパティ**を含めます。|
|**更新プログラムのインストール**|ソフトウェア更新プログラムをターゲット コンピューターにインストールする方法を指定します。 このステップが実行されるまで、対象のコンピューターは適用可能なソフトウェア更新プログラムが評価されません。 その時点で、評価内容は、他の Configuration Manager マネージド クライアントと似たものとなります。 詳細については、「[ソフトウェア更新プログラムのインストール](../understand/install-software-updates.md)」を参照してください。<br /><br />このステップでは、読み取り専用の `_SMSTSMediaType` タスク シーケンス変数が使用されます。 関連付けられた値が `FullMedia` と一致しない場合、このステップは実行されません。|
|**アプリケーションのインストール**|参照コンピューターにインストールするアプリケーションを指定します。|

### <a name="group-capture-the-reference-machine"></a>グループ: 参照コンピューターのキャプチャ

このグループには、参照コンピューターを準備してキャプチャするのに必要なステップが含まれます。

|タスク シーケンスのステップ|[説明]|  
|-------------------------------|---------------|  
|**構成マネージャー クライアントの準備**|参照コンピューター上で構成マネージャー クライアントが一般化されます。|
|**OS の準備**|Windows を一般化するために Sysprep が実行されます。 次にそれによって、タスク シーケンス用に指定された Windows PE ブート イメージにコンピューターが再起動されます。|
|**参照コンピューターのキャプチャ**|指定されたネットワーク共有と .WIM ファイルにイメージがキャプチャされます。|

> [!IMPORTANT]
> 参照コンピューターからイメージをキャプチャしたら、その参照コンピューターから別の OS イメージをキャプチャしないでください。 初期構成中にレジストリ エントリが作成されます。 OS イメージをキャプチャするたびに、新しい参照コンピューターを作成します。 同じ参照コンピューターを使用して将来の OS イメージを作成する計画である場合は、いったん構成マネージャー クライアントをアンインストールしてから再インストールします。

## <a name="next-steps"></a>次のステップ

[エンタープライズ オペレーティング システムを展開する方法](methods-to-deploy-enterprise-operating-systems.md)
