---
title: コレクションの評価
titleSuffix: Configuration Manager
description: コレクションの評価プロセス、種類、トリガーについて説明します。 コレクション評価グラフと階層について説明します。
ms.date: 06/05/2020
ms.prod: configuration-manager
ms.technology: configmgr-client
ms.topic: conceptual
ms.assetid: d17e1188-d277-438f-9236-db9cd213b421
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: af90154b848ddcd7cbff21917ef122ab10585098
ms.sourcegitcommit: 1d8bf691780b94a945e94945115d4d1df4242808
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/10/2020
ms.locfileid: "84663862"
---
# <a name="collection-evaluation-in-configuration-manager"></a>Configuration Manager でのコレクションの評価

*適用対象:Configuration Manager (Current Branch)*

Configuration Manager では、"*コレクションの評価*" を使用し、定義したコレクション規則に基づいてコレクションのメンバーシップを更新します。 コレクションの評価スコープとタイミングは、サイトとコレクションの構成と評価の種類によって異なります。 

コレクションの設計を適切に決定するには、コレクションの評価動作を理解しておくことが重要です。 コレクションの評価のガイダンスと推奨事項については、[コレクションのベスト プラクティス](best-practices-for-collections.md)に関するページを参照してください。

## <a name="evaluation-process"></a>評価プロセス

[colleval.log](https://docs.microsoft.com/mem/configmgr/core/plan-design/hierarchy/log-files#BKMK_ServerLogs) には、コレクション エバリュエーターによってコレクションが作成、変更、および削除された日時が記録されます。

大まかに言うと、個々のコレクションの評価と更新は以下の手順で行われます。

![コレクションの更新プロセスの概要](media/high-level-collection-update-process.png)

1. コレクション クエリを実行します。
1. 直接のメンバーであるすべてのシステムを追加します。
1. すべての "*包含*" コレクションを評価します。
   
   包含コレクションにクエリ規則もある場合、または包含または除外コレクションがある場合は、それらも評価します。 包含コレクション自体でコレクションが制限されている場合は、その下位のすべてのコレクションを評価します。 ツリーを完全に評価した後、呼び出し元のコレクションに結果を返します。
   
1. 返された結果と限定コレクションの間で論理 `AND` を実行します。
1. "*除外*" コレクションを評価します。
   
   除外コレクションにクエリ規則もある場合、または包含または除外コレクションがある場合は、それらも評価します。 これらのコレクション自体でコレクションが制限されている場合は、その下位のすべてのコレクションを評価します。 ツリーを完全に評価した後、呼び出し元のコレクションに結果を返します。
   
1. 直接のメンバーと包含コレクションを評価した結果セットを、除外コレクションを評価した結果と比較します。
1. 変更をデータベースに書き込み、更新を実行します。
1. すべての依存コレクションの更新もトリガーします。 依存コレクションとは、現在のコレクションで制限される、または包含または除外規則を使用して現在のコレクションを参照するコレクションです。

## <a name="collection-evaluation-types-and-triggers"></a>コレクションの評価の種類とトリガー

このような種類のスレッドでは、評価の種類に応じて、コレクションの評価が処理されます。

- スケジュールされたコレクションの更新の場合は、**プライマリ**
- 依存コレクションを使用してコレクションを手動で更新する場合は、**補助**
- 依存コレクションのないコレクションを手動で更新する場合は、**単一**
- コレクションの増分更新の場合は、**高速**

コレクションの評価トリガーとそれに対応する評価の種類を次の表に示します。 

| トリガー | 評価の種類 | [説明] |
|---------|-----------------|-------------|
|手動|単一または補助|手動は、最も優先度の高いコレクションの評価です。 管理者が手動のコレクションの評価を要求すると、コレクション エバリュエーターによって、次に使用できる評価スレッドが評価に割り当てられます。|
|スケジュール済み|プライマリ|スケジュールされた評価のプロセスは、評価がイベント駆動ではなく時間駆動であることを除いて、手動評価と同じです。|
|ステージング|単一または補助|すべてのコレクションは、直接的または間接的に、 **[すべてのシステム]** または **[すべてのユーザーおよびユーザー グループ]** に依存しています。 これらの両コレクションでは、毎日午前 4:00 に完全なコレクションの評価が行われます。 このようなコレクションのいずれかが変更されると、[完全なコレクション グラフ](#collection-evaluation-graph)に基づいて、依存コレクションの更新がトリガーされます。
|増分|高速|増分評価では、コレクション評価グラフを使用して、増分コレクション メンバーシップの更新が変更された場合に、依存コレクションを評価および更新します。 Configuration Manager では、増分更新用に構成されているすべてのコレクション内のリソース オブジェクトを監視および更新します。<br /><br />コレクション クエリが後で更新される情報 (ハードウェア インベントリなど) に基づいている場合、スケジュールされたコレクションの更新中は、Configuration Manager によってコレクションのリソースの追加または削除のみが行われます。|

## <a name="collection-evaluation-graph"></a>コレクション評価グラフ

"*コレクション評価グラフ*" を使用すると、評価対象のコレクションに関連するすべてのコレクションをマップできます。 コレクションの評価には、対象となるコレクションと、コレクション評価グラフ内の関連コレクションが含まれます。

コレクションの評価が始まると、Configuration Manager では、サイクルの最上位レベルから、対象となるコレクションに対する変更の結果として評価が必要になる可能性のあるすべてのコレクションを含むグラフが構築されます。 次に、コレクション エバリュエーターによってグラフが順番に移動され、各コレクション メンバーシップが順に評価されます。 コレクションが完全に評価されると、コレクション エバリュエーターによって、このサイクルの影響を受けない下位レベルのコレクションが、コレクション評価グラフから削除されます。

評価対象の 1 つ以上のコレクションに包含または除外規則がある場合、コレクション エバリュエーターによって、包含または除外されたコレクションは、コレクションで制限されているコレクションと共にグラフに追加されます。 包含および除外コレクションの評価中に変更があった場合、グラフはそのブランチで続行された後にメイン ブランチに戻ります。

Configuration Manager では、"*増分*" または "*完全*" の 2 種類の評価グラフが作成されます。

### <a name="incremental-collection-evaluation"></a>増分コレクション評価

テーブル データが変更されると、SQL トリガーによって **CollectionNotifications** テーブルに行が挿入されます。 次にコレクションの評価スケジュールが開始されると、`AND`既存のコレクション クエリでリソース ID が取得され、"*増分*" コレクションに対して有効なコレクションの更新がトリガーされます。

増分コレクション評価では、マシンごとに 1 つのクエリが実行されます。 増分コレクション評価の既定のサイト構成は、5 分間隔です。

増分コレクション評価グラフでは、増分評価に対して有効な場合にのみ、参照されるコレクションがマップされます。 増分評価が、増分評価に対して有効ではないコレクションに制限されている場合、グラフでは、限定コレクションの既存のメンバーシップに基づいてコレクションが評価されます。 

たとえば、次の図は、すべてのコレクションに適用できる、新しく検出されたリソースを示しています。 一方、コレクションの評価では、**すべてのサーバー**と**すべてのドメイン コントローラー**のコレクションのみが更新されます。 **すべてのメンバー サーバー** コレクションは増分評価に対して有効ではないため、コレクション エバリュエーターでは他のコレクションが評価されません。

![増分コレクション評価グラフの例](media/incremental-collection-evaluation-graph.png)

### <a name="full-collection-evaluation"></a>完全なコレクションの評価

手動またはスケジュールされたコレクションの評価を行うと、すべての依存コレクションの "*完全な*" コレクション評価グラフが作成されます。 グラフには、更新中のコレクションを参照するすべてのコレクションと後続のコレクションが含まれます。 処理中のコレクションに対する更新が発生している限り、Configuration Manager ではグラフの評価が続行されます。

次の図は、**すべてのサーバー** コレクションのスケジュールされた、または手動のコレクション更新要求によって、該当するすべてのコレクションを含む完全なグラフがどのように生成されるかを示しています。 新しい DNS サーバーとドメイン コントローラーのリソースは、すべてのコレクションのメンバーシップ クエリのスコープ内にあるため、すべてのコレクションが更新されます。

![完全なコレクション評価グラフの例 1](media/full-collection-evaluation-graph-1.png)

完全な評価では、常にすべてのコレクションが評価されるわけではありません。 コレクション評価グラフでは、現在参照されているコレクションに更新が発生した場合にのみ、依存コレクションの評価が続行されます。 スケジュールされた増分評価中に増分更新コレクションが更新された場合、増分更新が有効ではない参照コレクションは更新されない場合があります。 完全な評価ではコレクションが更新されず、コレクション評価グラフとそのサイクルの参照元のコレクションの評価が終了します。 

次の例では、既存のサーバーに DNS をインストールすると、**DNS サーバー** コレクションのメンバーになりますが、制限のある**すべてのメンバー サーバー** コレクションに対する更新がないため、完全な評価では **DNS サーバー** コレクションが評価されません。 次の増分評価サイクルでは、増分コレクションであるため、**DNS サーバー** コレクションが評価されます。

![完全なコレクション評価グラフの例 2](media/full-collection-evaluation-graph-2.png)

## <a name="next-steps"></a>次のステップ
- [コレクションを作成する方法](create-collections.md)
- [コレクションのベスト プラクティス](best-practices-for-collections.md)
- [Collection Evaluation Viewer](https://docs.microsoft.com/mem/configmgr/core/support/ceviewer)
- TechEd Australia での「[ConfigMgrDogs Troubleshoot ConfigMgr 2012 (ConfigMgrDogs による ConfigMgr 2012 のトラブルシューティング)](https://channel9.msdn.com/Events/TechEd/Australia/2014/DCI411)」セッション
