---
title: データベースのレプリケーション
titleSuffix: Configuration Manager
description: Configuration Manager のデータベース レプリケーションが SQL Server を使用して階層のデータを転送する方法について説明します。
ms.date: 08/09/2019
ms.prod: configuration-manager
ms.technology: configmgr-core
ms.topic: conceptual
ms.assetid: 8b495b02-c966-4eb3-92b9-52ebbf5c38ae
author: mestew
ms.author: mstewart
manager: dougeby
ms.openlocfilehash: d1a2c8baa349e6499aa483f947d94f7459357be4
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/21/2020
ms.locfileid: "81703600"
---
# <a name="database-replication"></a>データベースのレプリケーション

*適用対象:Configuration Manager (Current Branch)*

Configuration Manager のデータベース レプリケーションは SQL Server を使用して階層のデータを転送します。 この方法を使用して、サイト データベースの変更を、階層内の他のサイトのデータベースの情報とマージします。

データベース レプリケーションについては、次の点に注意してください。

- すべてのサイトが同じ情報を共有します。  

- サイトを階層にインストールすると、Configuration Manager によって、新しいサイトとその親サイトの間のデータベース レプリケーションが自動的に確立されます。  

- サイトのインストールが終了すると、データベースのレプリケーションが自動的に開始されます。  

階層に新しいサイトを追加すると、Configuration Manager は、その新しいサイトで汎用データベースを作成します。 親サイトでは、データベース内の関連するデータのスナップショットが作成されます。 次に、[ファイルベースのレプリケーション](file-based-replication.md)を使用して、スナップショットが新しいサイトに転送されます。 次に、新しいサイトが SQL Server の一括コピー プログラム (BCP) を使用して、情報を Configuration Manager データベースのローカル コピーに読み込みます。 スナップショットが読み込まれると、各サイトが他のサイトとのデータべース レプリケーションを開始します。  

サイト間でデータをレプリケートするために、Configuration Manager は、データベース レプリケーション サービスを使用します。 データベース レプリケーション サービスは SQL Server の変更追跡を使用して、ローカル サイト データベースの変更を監視します。 その後、SQL Server Service Broker (SSB) を使用して、その変更を他のサイトにレプリケートします。 既定では、このプロセスで TCP ポート 4022 が使用されます。  


## <a name="replication-groups"></a>レプリケーション グループ

Configuration Manager は、データベース レプリケーションによってレプリケートするデータを、複数のレプリケーション グループにグループ化します。 レプリケーション グループごとに、別々のレプリケーション スケジュールが定められています。 サイトは、このスケジュールを使用して、変更を他のサイトにレプリケートする頻度を決定します。  

たとえば、ロール ベース管理の構成の変更は、他のサイトにすばやくレプリケートされます。 この動作により、他のサイトでも変更を迅速に適用できるようになります。 緊急ではない構成変更 (新しいセカンダリ サイトのインストールを要求した場合など) は、直ちにレプリケートされません。 新しいサイトの要求が目的のプライマリ サイトに達するまでに数分かかります。  


## <a name="settings"></a>Settings

データベース レプリケーションについて、次の設定を変更することができます。  

- **データベース レプリケーション リンク**: 特定のトラフィックがネットワークを通過する時間を制御できます。  

- **分散ビュー**: 中央管理サイト (CAS) で選択されたサイト データが要求されると、子プライマリ サイトのデータベースから直接、そのデータにアクセスできます。  

- **スケジュール**: レプリケーション リンクをいつ使用するか、および各種サイト データをいつレプリケートするかを指定できます。  

- **概要作成**: レプリケーション リンクを通過するネットワーク トラフィックについて、データの概要作成のための設定を変更します。 既定では、概要作成は 15 分ごとに実行されます。 これは、データベース レプリケーションのレポートに使用されます。  

- **データベース レプリケーションのしきい値**: サイトでリンクを "低下" または "失敗" とレポートするタイミングを定義します。 また、Configuration Manager で、"低下" または "失敗" の状態を持つ、レプリケーション リンクに関するアラートを生成するタイミングを構成できます。  


## <a name="types-of-data"></a>データの種類

Configuration Manager は主に、レプリケートするデータを*グローバル データ*または*サイト データ*として分類します。 データベース レプリケーションが行われると、グローバル データとサイト データへの変更は、データベース レプリケーション リンク全体に転送されます。 グローバル データは、親サイトまたは子サイトにレプリケートされます。 サイト データは、親サイトにのみレプリケートされます。 3 つ目のデータの種類である*ローカル データ*は、他のサイトにレプリケートされません。 ローカル データは、他のサイトで必要とされない情報です。  

### <a name="global-data"></a>グローバル データ

グローバル データは、階層全体のすべてのサイトにレプリケートされる管理者作成のオブジェクトです。 セカンダリ サイトは、グローバル データのサブセットのみをグローバル プロキシ データとして受信します。 グローバル データは、CAS とプライマリ サイトで作成します。 この種類には、次のデータが含まれます。

- ソフトウェアの展開
- ソフトウェア更新プログラム
- コレクションの定義
- 役割に基づいた管理のセキュリティ スコープ

### <a name="site-data"></a>サイト データ

サイト データは Configuration Manager プライマリ サイトとこれによって割り当てられたクライアントによって作成される操作情報です。 サイト データは、CAS にレプリケートされますが、他のプライマリ サイトにはレプリケートされません。 サイト データは、CAS と、データの作成元のプライマリ サイトだけで見ることができます。 サイト データの変更は、その作成元のプライマリ サイトだけで行えます。 この種類には、次のデータが含まれます。

- ハードウェア インベントリ
- ステータス メッセージ
- アラート
- クエリベースのコレクションの結果

すべてのサイトデータが CAS にレプリケートされます。 CAS はサイト階層全体の管理とレポート作成を行います。  


## <a name="database-replication-links"></a><a name="bkmk_Dblinks"></a> データベース レプリケーション リンク

新しいサイトを階層にインストールすると、Configuration Manager によって、親サイトと新しいサイトの間のデータベース レプリケーション リンクが自動的に作成されます。 この 2 つのサイト間を接続するリンクが 1 つ作成されます。  

レプリケーション リンク間のデータの転送を制御するには、各リンクの設定を変更します。 各レプリケーション リンクは、個別の構成をサポートします。 データベース レプリケーション リンクには、それぞれ次の制御が含まれます。  

- プライマリ サイトから CAS への、選択したサイト データのレプリケーションを停止する。 このアクションによって、CAS はプライマリ サイトのデータベースから直接このデータにアクセスできるようになる。  

- 選択したサイト データを、子プライマリ サイトから CAS に転送するようにスケジュールする。

- データベース レプリケーション リンクがいつ "低下" 状態または "失敗" 状態になったかを特定するための設定を定義する。

- 失敗したレプリケーション リンクのアラートを生成するタイミングを指定する。

- Configuration Manager で、レプリケーション リンクを使用したレプリケーション トラフィックに関するデータを要約する頻度を指定する。 このデータがレポートで使用される。

データベース レプリケーション リンクを構成するには、Configuration Manager コンソールで、 **[監視]** ワークスペースに移動します。 **[データベースのレプリケーション]** ノードを選択し、リンクのプロパティを編集します。 このノードは、 **[管理]** ワークスペースの **[階層の構成]** ノードにもあります。 レプリケーション リンクは、レプリケーション リンクの親サイトまたは子サイトから編集します。  

> [!TIP]  
> データベース レプリケーション リンクは、いずれかのワークスペースの **[データベースのレプリケーション]** ノードから編集できます。 ただし、 **[監視]** ワークスペースの **[データベースのレプリケーション]** ノードを使用して、データベース レプリケーションの状態を表示することもできます。 また、[レプリケーション リンク アナライザー](../../servers/manage/monitor-replication.md#BKMK_RLA) ツールにアクセスすることもできます。 このツールを使用すると、データベース レプリケーションに関する問題を調査できます。  

レプリケーション リンクの構成方法の詳細については、「[サイト データベース レプリケーションの制御](#BKMK_DBRepControls)」を参照してください。 レプリケーションを監視する方法の詳細については、「[データベース レプリケーションの監視](../../servers/manage/monitor-replication.md)」をご覧ください。  


## <a name="distributed-views"></a><a name="bkmk_distviews"></a> 分散ビュー  

分散ビューを使用して、CAS で選択したサイト データに対して要求を行うと、子プライマリ サイトのデータベースに直接アクセスできます。 この直接アクセスにより、サイト データをプライマリ サイトから CAS にレプリケートする必要がなくなります。 各レプリケーション リンクは他のレプリケーション リンクから独立しているため、選択したレプリケーション リンクで分散ビューを使用できます。 プライマリ サイトとセカンダリ サイトの間で分散ビューを使用することはできません。  

分散ビューには、次の利点があります。  

- CAS とプライマリ サイトでデータベース変更を処理するための CPU 負荷が軽減される

- ネットワーク経由で CAS に転送されるデータ量が低減される

- CAS のデータベースをホストする SQL Server のパフォーマンスが向上する

- CAS のデータベースで使用されるディスク領域が削減される

プライマリ サイトがネットワーク上で CAS の近くにあり、2 つのサイトが常に動作し、常にネットワークに接続されている場合は、分散ビューの使用を検討してください。 分散ビューでは、選択したデータのレプリケーションをサイト間で実行する代わりに、各サイトの SQL Server 間で直接接続をするためです。 CAS では、このデータが要求されるたびに直接接続が確立されます。

サイトにより、次のようなシナリオで分散ビューのデータが要求されます。

- レポートまたはクエリを実行する場合
- リソース エクスプローラーで情報を表示する場合
- サイト データベースのルールを含むコレクションのコレクション評価

既定では、分散ビューはレプリケーション リンクごとに無効にされます。 分散ビューを有効にする場合は、そのリンクを介して CAS にレプリケートしないサイト データを選択します。 CAS は、リンクを共有する子プライマリ サイトのデータベースから直接、このデータにアクセスします。 分散ビューでは、次の種類のサイト データを構成できます。  

- クライアントからの**ハードウェア インベントリ** データ
- クライアントからの**ソフトウェア インベントリおよび使用状況測定**データ
- クライアント、プライマリ サイト、すべてのセカンダリ サイトからの**ステータス メッセージ**

Configuration Manager コンソールまたはレポートでデータを表示する場合、操作上、分散ビューが表示されません。 分散ビューに対して有効になっているデータを要求すると、CAS サイトのデータベース サーバーでは、子プライマリ サイトのデータベースに直接アクセスして情報が取得されます。

たとえば、CAS に接続している Configuration Manager コンソールを使用します。 ハードウェア インベントリに関する情報を次の 2 つのプライマリ サイトに対して要求します。ABC と XYZ です。 分散ビューのハードウェア インベントリはサイト ABC のみで有効になっています。 CAS は、XYZ クライアントのインベントリ情報を独自のデータベースから取得します。 CAS は、ABC クライアントのインベントリ情報をサイト ABC のデータベースから直接取得します。 この情報は、ソースの区別なく、Configuration Manager コンソールまたはレポートに表示されます。  

分散ビューに対して有効にされているデータの種類がレプリケーション リンクにある場合、子プライマリ サイトは、CAS にそのデータをレプリケートしません。 あるデータの種類に対して分散ビューを無効にすると、子プライマリ サイトは、CAS への通常のデータ レプリケーションを再開します。 ただし、このデータが CAS で利用可能になるには、このデータのレプリケーション グループが、プライマリ サイトと CAS の間で再初期化される必要があります。 分散ビューが有効にされたプライマリ サイトをアンインストールした後、CAS 上の分散ビューを有効にしたデータに アクセスするには、CAS でデータの再初期化を完了する必要があります。  

> [!IMPORTANT]  
> サイト階層内の任意のレプリケーション リンクで分散ビューを使用する場合、いずれかのプライマリ サイトをアンインストールする前に、すべてのレプリケーション リンクで分散ビューを無効にします。 詳細については、[分散ビューを使用するプライマリ サイトのアンインストール](../../servers/deploy/install/uninstall-sites-and-hierarchies.md#bkmk_distviews)に関するページをご覧ください。  

### <a name="prerequisites-and-limitations-for-distributed-views"></a>分散ビューの前提条件と制限  

- 分散ビューは、CAS とプライマリ サイト間のレプリケーション リンクでのみ使用します。

- CAS は SQL Server Enterprise Edition を使用する必要があります。 プライマリ サイトには、この要件はありません。

- CAS は、SMS プロバイダーのインスタンスを 1 つだけ含むことができます。 サイト データベース サーバーにその 1 つのインスタンスをインストールします。 この構成では、Kerberos 認証がサポートされます。 CAS の SQL Server が子プライマリ サイトの SQL Server にアクセスするには Kerberos が必要です。 子プライマリ サイトの SMS プロバイダーに制限はありません。

- CAS には1 つのレポート サービス ポイントしかインストールできません。 サイト データベース サーバーに SQL Server Reporting Services をインストールします。 この構成では、Kerberos 認証がサポートされます。 CAS の SQL Server が子プライマリ サイトの SQL Server にアクセスするには Kerberos が必要です。

- [SQL Server クラスター](../../servers/deploy/configure/use-a-sql-server-cluster-for-the-site-database.md)上で、サイト データベースをホストすることはできません。

- 1902 以前のバージョンでは、[SQL Server Always On 可用性グループ](../../servers/deploy/configure/sql-server-alwayson-for-a-highly-available-site-database.md)上で、サイト データベースをホストすることはできません。 この構成をサポートするには、バージョン 1906 以降に更新します。<!-- SCCMDocs-pr#3792 -->

- CAS データベース サーバーのコンピューター アカウントには、プライマリ サイト データベースに対する**読み取り**アクセス許可が必要です。

> [!IMPORTANT]  
> 分散ビューと、データをレプリケートできる[スケジュール](#BKMK_schedules)は、データベース レプリケーション リンクで相互に排他的な設定です。  


## <a name="schedule-transfers-of-site-data"></a><a name="BKMK_schedules"></a> サイト データの転送のスケジュール

子プライマリ サイトで、その CAS にサイト データをレプリケートするために使用されるネットワーク帯域幅を制御できるようにするには、レプリケーション リンクを使用するタイミングをスケジュールします。 次に、さまざまな種類のサイト データをレプリケートするタイミングを指定します。 プライマリ サイトで、ステータス メッセージ、インベントリ、使用状況データをレプリケートする時間を制御できます。 セカンダリ サイトからのデータベース レプリケーション リンクでは、サイト データのスケジュールはサポートされません。 グローバル データの転送はスケジュールできません。  

データベース レプリケーション リンクのスケジュールを構成するときに、プライマリ サイトから CAS への選択したサイト データの転送を制限できます。 また、サイト データをレプリケートする時間を種類ごとに構成することもできます。  

> [!IMPORTANT]  
> [分散ビュー](#bkmk_distviews)と、データをレプリケートできるスケジュールは、データベース レプリケーション リンクで相互に排他的な構成です。  


## <a name="summarization-of-traffic"></a><a name="BKMK_SummarizeDBReplication"></a> トラフィックの概要  

各サイトは、サイトに対するデータベース レプリケーション リンクを通過するネットワーク トラフィックに関するデータの概要を定期的に作成します。 概要データは、データベース レプリケーションのレポートに使用されます。 レプリケーション リンクの両方のサイトは、レプリケーション リンクを通過するネットワーク トラフィックの概要を作成します。 データの概要は、サイト データベース サーバーで作成されます。 データの概要が作成されると、この情報は、グローバル データとして他のサイトにレプリケートされます。  

既定では、概要作成は 15 分ごとに実行されます。 ネットワーク トラフィックの概要作成の頻度を変更するには、データベース レプリケーション リンクのプロパティの **[概要の作成間隔]** を編集します。 概要作成の頻度は、データベース レプリケーションに関するレポートに表示される情報に影響します。 5 分から 60 分の間隔を選択できます。 概要作成の頻度を増やすと、レプリケーション リンクの各サイトの SQL Server での処理負荷が増加します。  

## <a name="database-replication-thresholds"></a><a name="BKMK_DBRepThresholds"></a> データベース レプリケーションのしきい値

データベース レプリケーションのしきい値は、Configuration Manager がデータベース レプリケーション リンクの状態を "低下" または "失敗" としてレポートする基準を定義します。 既定では、連続する 12 回の試行中にいずれか 1 つのレプリケーション グループがレプリケーションの完了に失敗した場合、リンクは "*低下*" に設定されます。 連続する 24 回の試行中にいずれか 1 つのレプリケーション グループがレプリケーションに失敗した場合は、"*失敗*" に設定されます。  

低下、または失敗の状態のカスタム値を指定できます。 この値を調整すると、リンク全体のデータベース レプリケーションの正常性をより正確に監視できます。  

1 つまたは複数のレプリケーショング ループがレプリケートに失敗しても、他のレプリケーション グループの正常なレプリケートが続きます。 リンクのレプリケーション状態の確認は、最初に低下が報告されたときに行うように計画してください。

低下状態または失敗状態のリンクの再試行値の変更は、次の状況で検討してください。

- 特定のレプリケーション グループで遅延が繰り返されるが、遅延が問題ではない。

- サイト間のネットワーク リンクで使用可能な帯域幅が減少している。

サイトによってリンクが低下または失敗に設定されるまでの再試行回数を増やすと、既知の問題に対して誤った警告が通知されなくなります。 この操作により、リンクの状態をさらに正確に追跡できるようになります。  

グループのレプリケーションの実行頻度を把握するために、各レプリケーション グループのレプリケーションの同期間隔を検討します。 レプリケーション グループの **[同期間隔]** を表示するには、Configuration Manager コンソールの **[監視]** ワークスペースに移動します。 **[データベースのレプリケーション]** ノードで、レプリケーション リンクの **[レプリケーションの詳細]** タブを選択します。  

レプリケーション状態の表示方法を含む、データベース レプリケーションの監視方法の詳細については、「[データベース レプリケーションの監視](../../servers/manage/monitor-replication.md)」セクションをご覧ください。  


## <a name="site-database-replication-controls"></a><a name="BKMK_DBRepControls"></a> サイト データベース レプリケーションの制御  

データベースのレプリケーションに使用するネットワーク帯域幅を効果的に制御するには、各サイト データベースの設定を変更します。 これらの設定は、設定を構成したサイト データベースにのみ適用されます。 設定は、他サイトへのデータベースのレプリケーションによって、サイトがデータをレプリケートするときに常に使用されます。  

サイト データベースごとに変更できるレプリケーションの制御項目を次に示します。  

- SSB ポート  

- レプリケーション エラーにより、サイトがサイト データベースのコピーの再初期化をトリガーするまでの待機時間。  

- サイトによってレプリケートされるデータの圧縮。 データは、サイト間の転送のみを目的として圧縮され、両サイトのサイト データベースへの保存を目的としていません。  

サイト データベースのレプリケーション制御用の設定を構成するには、Configuration Manager コンソールの **[データベース レプリケーション]** ノードで、サイト データベースのプロパティを編集します。 このノードは、 **[管理]** ワークスペースの **[階層の構成]** と、 **[監視]** ワークスペースに表示されます。 サイト データベースのプロパティを編集するには、サイト間のレプリケーション リンクを選択し、 **[親データベースのプロパティ]** または **[子データベースのプロパティ]** を開きます。  

> [!TIP]  
> データベース レプリケーションの制御は、いずれかのワークスペースの **[データベースのレプリケーション]** ノードから編集できます。 ただし、 **[監視]** ワークスペースの **[データベースのレプリケーション]** ノードを使用すると、レプリケーション リンクのデータベースのレプリケーションの状態を表示したり、レプリケーションに関する問題を調査するときに役立つ、レプリケーション リンク アナライザーにアクセスしたりできます。  


## <a name="see-also"></a>関連項目

[レプリケーションの監視](../../servers/manage/monitor-replication.md)

[SQL レプリケーションのトラブルシューティング](../../servers/manage/replication/overview.md)
